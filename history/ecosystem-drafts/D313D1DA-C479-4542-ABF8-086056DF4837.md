<!--
  SPDX-FileCopyrightText: 2025 Kerrick Long <me@kerricklong.com>
  SPDX-License-Identifier: CC-BY-SA-4.0
-->

> [!NOTE]
> This is an archived brainstorming document generated with an LLM. Personas and organizations mentioned are fictional. See [index.md](index.md) for context.

This is **The Technical Writer**.  
Following the directive of the CEO, I have facilitated the drafting session with the **Council of Architects** (chaired by our Internal Architect, with input from Elmer, Reagan, Rainier, Troy, Glinda, Gemma, Gordon, and Russel).  
We submitted the draft to the **Internal Staff** (Project Manager, Product Owner) for rigorous critique. We debated the implementation of Cmd batching, the strictness of Ractor checks, and the naming conventions for the Glimmer hooks.  
**I am pleased to report we have reached Unanimous Agreement.**  
There are no impasses. The "Jujube" core, fortified with "Apple" composition patterns and "Fig" integration hooks, satisfies every stakeholder from the low-level Rust engineer to the high-level Rails developer.  
Here is the final, canonical Architecture Definition Document.

# ---

**Architecture Definition Document: ratatui\_ruby-tea**

Codename: Gem 1.25 ("Jujube Prime")  
Version: 1.0.0 (Canonical)  
Status: APPROVED FOR EXECUTION  
Dependency: Requires ratatui\_ruby \>= 0.4.0 (Must support poll\_event(timeout:)).

## ---

**1\. Executive Vision: "The Standard Architecture"**

**ratatui\_ruby-tea** is a high-level runtime for Terminal User Interfaces. It implements **The Elm Architecture (TEA)**—also known as Model-View-Update (MVU)—on top of the ratatui\_ruby engine.

### **The Philosophy**

We are solving the "Spaghetti Code" problem in CLI tools.

* **For the Rubyist:** This is **"Rails for the Console."** We provide a standard place for State (Model), Logic (Update), and Layout (View).  
* **For the Polyglot:** This is **"Redux for the Terminal."** We provide a single immutable source of truth and unidirectional data flow.

### **The "Big Tent" Context**

This gem represents **Path A** of the RatatuiRuby Ecosystem Strategy.

* **Optimized For:** Control, Flow, Tools, Wizards, State Machines.  
* **Not Optimized For:** Complex Dashboards (See *ratatui\_ruby-components*), Object-Oriented widget trees.

## ---

**2\. System Architecture**

### **2.1 The "Fast Loop" Runtime**

The heart of the gem is the RatatuiRuby::TEA::Program class. It manages a **Synchronous UI Loop** paired with an **Asynchronous Worker Pool**.

* **Main Thread (UI):** Handles Input, Update, and Drawing.  
  * *Constraint:* The Update function **must not block**. It calculates new state and returns. It never sleeps or makes network requests.  
* **Worker Threads (Background):** Handle Cmd execution (Side Effects).  
  * *Mechanism:* When Update returns a Cmd, the runtime spawns a thread (or utilizes a thread pool) to execute it.  
  * *Synchronization:* Results are pushed to a thread-safe Queue as Msg objects.

### **2.2 The Concurrency Model: "The Trojan Horse"**

We are building for Ruby 3.2 (Threads) but enforcing Ruby 4.0 (Ractors) discipline.

* **Rule:** The **Model** and all **Messages** must be **Ractor-Shareable** (Deeply Frozen).  
* **Enforcement:** In development mode, the Runtime runs Ractor.make\_shareable(msg) logic validation. If a user passes a mutable object (like a socket or raw Proc) in a Message, the application raises a ConcurrencyError.  
* **Benefit:** In v2.0, we can swap the internal engine to use Ractors for true parallelism without breaking user code.

## ---

**3\. The Developer Experience (API)**

We reject inheritance (class App \< Base). We adopt **Callable Objects** (Composition). This supports two distinct coding styles ("Flavors") within the same architecture.

### **Flavor A: The "Script" (Functional)**

Target: Angie (App Dev), Troy (CLI Dev).  
A simple, single-file script using Procs.

Ruby

Model \= Data.define(:count)  
\# Update is just a Proc  
update \= \-\>(msg, model) {  
  case msg  
  when :inc then \[model.with(count: model.count \+ 1), nil\]  
  when :quit then \[model, :quit\]  
  end  
}  
\# View is just a Proc  
view \= \-\>(model) { RatatuiRuby::Paragraph.new(text: model.count.to\_s) }

RatatuiRuby::TEA::Program.new(Model.new(count: 0), update: update, view: view).run

### **Flavor B: The "App" (Object-Oriented)**

Target: Rainier (Rails Dev), Enterprise Teams.  
Structured Service Objects.

Ruby

\# app/controllers/counter\_controller.rb  
class CounterController  
  def call(msg, model)  
    \# Business logic here...  
  end  
end

RatatuiRuby::TEA::Program.new(  
  model: InitialState.new,   
  update: CounterController.new,   
  view: MainLayout.new  
).run

## ---

**4\. Core Components**

### **4.1 The Message (Msg)**

* **Definition:** Data representing an event.  
* **Types:** Symbols (signals) or Data Objects (payloads).  
* **Protocol:** Must be serializable/frozen.

### **4.2 The Command (Cmd)**

* **Definition:** An intent to perform work. A value object wrapping a job.  
* **Interface:** Cmd objects respond to \#call and return a Msg.  
* **Composition:** We include Cmd\#map. This allows a parent component to transform the result of a child component's command (Crucial for *Fractal Architecture*).

### **4.3 Batteries Included (Standard Library)**

We ship with **Zero-Dependency** implementations of common tasks.

1. **Cmd::Wait**: Sleeps for $N$ seconds, returns a Msg.  
2. **Cmd::Tick**: A recurring timer (Spinner logic).  
3. **Cmd::Exec**: Wraps Open3. Runs shell commands, captures stdout/stderr, returns a Msg.  
4. **Cmd::Batch**: Runs multiple commands in parallel.  
5. **Cmd::Sequence**: Runs commands in serial order.  
6. **Cmd::NetHttp**: A wrapper around Net::HTTP.  
   * *Note:* Users can bring Faraday or HTTPX by wrapping them in a generic Cmd.call.

## ---

**5\. Integration Hooks (The "Fig" Patch)**

To support the future **Glimmer DSL** (Layer 2), we establish the following convention immediately.

* **The Problem:** Glimmer relies on bi-directional binding (text \<= \[model, :name\]). TEA relies on immutable state.  
* **The Solution:** **"Sugar for Dispatch."**  
* **The Hook:** We reserve the message namespace RatatuiRuby::TEA::Msg::FieldUpdated.  
* **Behavior:** Future Glimmer adapters will emit this message when a user interacts with a form field. The user's Update function can listen for this message to update the model.

## ---

**6\. Execution Roadmap**

### **Phase 1: The Engine Blocker (P0)**

* **Task:** Modify ext/ratatui\_ruby/src/events.rs.  
* **Action:** Expose crossterm::event::poll with a timeout parameter.  
* **Verify:** Ensure RatatuiRuby.poll\_event(timeout: 0.016) returns nil instantly if no input exists.

### **Phase 2: The Core Runtime**

* **Task:** Implement RatatuiRuby::TEA::Program.  
* **Logic:** Build the Main Thread / Worker Thread loop.  
* **Safety:** Implement validate\_ractor\_safety\! (Debug Mode).

### **Phase 3: The Batteries**

* **Task:** Implement Cmd::Batch, Cmd::Sequence, Cmd::Exec, Cmd::Wait.  
* **Task:** Implement Cmd::NetHttp (Reference implementation).

### **Phase 4: Documentation & Examples**

* **Task:** Write the "Zero to Hero" guide.  
* **Constraint:** Use "Rails" terminology (Model/Controller/View) alongside "Redux" terminology to bridge the gap.  
* **Example:** "The GitHub Star Fetcher" (demonstrates Cmd::NetHttp and Msg::FieldUpdated).

---

**Signed and Ratified By:**

* **Internal Architect (Chair)**  
* **The Staff** (PM, PO, Tech Writer)  
* **The Council** (Elmer, Reagan, Rainier, Troy, Glinda, Gemma, Gordon, Russel, Angie)

**Ready for Implementation.**