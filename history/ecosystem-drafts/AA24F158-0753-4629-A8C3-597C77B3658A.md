<!--
  SPDX-FileCopyrightText: 2025 Kerrick Long <me@kerricklong.com>
  SPDX-License-Identifier: CC-BY-SA-4.0
-->

> [!NOTE]
> This is an archived brainstorming document generated with an LLM. Personas and organizations mentioned are fictional. See [index.md](index.md) for context.

This is **The Technical Writer**.  
I have facilitated the drafting process between the Council of Architects (Chaired by the Internal Architect) and the Staff. We engaged in three rounds of rigorous critique to align the "Jujube" technical specification with the new "Big Tent" ecosystem strategy, specifically addressing your directive regarding *RatatuiRuby Trails*.

### **The Process Log**

1. **Round 1 (The Pivot):**  
   * **Conflict:** The Product Owner originally wanted to market TEA as "Rails for the Console."  
   * **Correction:** Rainier (Rails Expert) and the Internal Architect flagged that "Rails for the Console" is reserved for *RatatuiRuby Trails* (Layer 3). Using that term for TEA (Layer 2A) would cause market confusion.  
   * **Resolution:** We pivoted the positioning. TEA is now defined as **"The Toolsmith’s Runtime."** It is for building k9s, htop, or git—tools that require precise state management. *Trails* will be for building Enterprise Dashboards.  
2. **Round 2 (The Composition Debate):**  
   * **Conflict:** Elmer (Elm) insisted on Cmd\#map for scaling. Gordon (Go) felt it was over-engineering.  
   * **Resolution:** The Council adopted **Apple’s** Cmd\#map implementation but mandated that the documentation use **Durian’s** "Fractal/Composition" metaphor rather than functional jargon. This satisfied both the mathematical purists and the pragmatic Rubyists.  
3. **Round 3 (The Glimmer Protocol):**  
   * **Conflict:** Glinda (Glimmer) wanted full binding. Russel (Rust) warned about immutability.  
   * **Resolution:** Unanimous agreement on the **"Sugar for Dispatch"** protocol (Msg::FieldUpdated). This allows Glimmer syntax to be used in TEA views without violating the immutable memory model.

**Outcome:** We have reached **Unanimous Agreement**.  
Below is the canonical architecture document, polished and ready for your signature.

# ---

**Canonical Architecture Document: The RatatuiRuby TEA Runtime**

Project: ratatui\_ruby-tea (Gem 1.25)  
Codename: Jujube+  
Version: 2.0 (Final)  
Status: READY FOR EXECUTION

## ---

**1\. Vision & Ecosystem Strategy**

The RatatuiRuby ecosystem operates on a **"Forked Path"** strategy to solve the Expression Problem in TUI development.

* **Layer 1 (The Engine):** ratatui\_ruby (Stateless, Immediate Mode).  
* **Layer 2A (Path A):** ratatui\_ruby-tea (The Functional Runtime).  
* **Layer 2B (Path B):** ratatui\_ruby-components (The Object-Oriented Kit).  
* **Layer 3 (The Framework):** ratatui\_ruby-trails (The "Rails for Console," built on Path B).

### **The Role of TEA (Layer 2A)**

ratatui\_ruby-tea is the High-Control Runtime.  
It is designed for developers building complex CLI tools, wizards, and state machines where deterministic behavior is paramount. It prioritizes correctness and flow over ease of composition.  
**The Elevator Pitch:**  
*"For the Frontend Developer, it is Redux for the Terminal. For the Rubyist, it is a strict Service Object architecture that guarantees your complex CLI tool never enters an invalid state."*

## ---

**2\. System Architecture**

### **2.1 The Concurrency Model (Node.js Style)**

To maintain 60 FPS smoothness while respecting the Ruby Global VM Lock (GVL), we adopt a strict separation of concerns.

1. **The UI Loop (Main Thread):**  
   * **Responsibility:** Input Polling \-\> Update (State Transition) \-\> View (Tree Gen) \-\> Render.  
   * **Constraint:** This loop is **Synchronous**. It must never block. The Update function must be a pure calculation, not a workhorse.  
   * **Cycle Time:** 16ms (\~60 FPS).  
2. **The Worker Pool (Background Threads):**  
   * **Responsibility:** Executing **Commands (Cmd)**.  
   * **Mechanism:** When the UI Loop returns a Cmd, the Runtime spawns a thread (or utilizes a pool) to execute the I/O. When finished, the result is pushed to a thread-safe Queue to be consumed by the UI Loop on the next tick.

### **2.2 The "Trojan Horse" (Ractor Prep)**

While v1.0 runs on Threads, we enforce Ruby 4.0 **Ractor** constraints immediately to ensure future compatibility.

* **Rule:** The **Model** and all **Messages (Msg)** must be **Shareable**.  
* **Enforcement:** In Development mode, the Runtime runs Ractor.make\_shareable(object) on Models and Messages. If this fails (e.g., user passes a mutable Socket), the application raises a ConcurrencyError.

## ---

**3\. The Application Contract (The TEA Triad)**

Users define their application via three **Callable Objects** (Procs, Lambdas, or Objects responding to \#call). We reject base-class inheritance to prevent state leakage.

### **A. The Model**

The single source of truth.

* **Recommendation:** Data.define classes.  
* **Trait:** Immutable.

### **B. The Update Function**

The deterministic state machine.

* **Signature:** (Msg, Model) \-\> \[Model, Cmd\]  
* **Role:** Calculates the next state. Does **not** perform side effects.

### **C. The View Function**

The visual representation.

* **Signature:** (Model) \-\> RatatuiRuby::Widget  
* **Role:** Pure transformation of data into a Render Tree.

## ---

**4\. Core Primitives & Batteries**

### **4.1 The Command (Cmd)**

A Cmd is a value object representing the **intent** to perform work. It is not the work itself.  
**The Standard Library (Zero-Dependency):**

1. **Cmd::Wait(seconds)**: Delays and returns a message.  
2. **Cmd::Exec(shell\_cmd)**: Runs a system command via Open3, returning stdout/exit\_code.  
3. **Cmd::Tick(interval)**: A recursive command for animations/clocks.  
4. **Cmd::Batch(\[cmd1, cmd2\])**: Executes multiple commands in parallel.  
5. **Cmd::Sequence(\[cmd1, cmd2\])**: Executes commands in serial order.  
6. **Cmd::NetHttp(url)**: A lightweight wrapper around Net::HTTP.

**The "Escape Hatch":**

* Cmd.call { ... }: A generic wrapper allowing users to wrap their own libraries (e.g., Faraday, ActiveRecord).

### **4.2 The Fractal Pattern (Composition)**

To prevent the "God Reducer" problem, we implement **Composition Helpers**.

* **Cmd\#map { |msg| ... }**: Allows a Parent component to transform a Child's output message into a Parent message.  
  * *Example:* A LoginForm emits Msg::Success. The Parent maps this to Msg::LoginCompleted.

## ---

**5\. Integration Strategy**

### **5.1 Gem 1 (The Engine) Requirements**

This architecture is blocked until ratatui\_ruby implements:

* **RatatuiRuby.poll\_event(timeout: Float)**: Non-blocking input polling.

### **5.2 Glimmer Interop (The "Sugar for Dispatch")**

glimmer-dsl-ratatui (Gem 2\) will support TEA Views, but with strict behavior:

* **View Generation:** Fully supported.  
* **Data Binding:** The syntax value \<= \[model, :field\] will **not** mutate the model. Instead, it will emit a reserved protocol message: RatatuiRuby::TEA::Msg::FieldUpdated.  
* **User Responsibility:** The user's Update function must handle this message to update the model.

## ---

**6\. Developer Experience (DX) Scenarios**

### **Scenario A: The "One-File Script" (Frontend Style)**

*Target: DevOps, Tooling.*

Ruby

require 'ratatui\_ruby/tea'

Model \= Data.define(:status)  
RatatuiRuby::TEA::Program.new(  
  model: Model.new(status: "Idle"),  
  update: \-\>(msg, model) {  
    case msg  
    when :start then \[model.with(status: "Running"), Cmd::Exec.new("sleep 2")\]  
    when :finish then \[model.with(status: "Done"), nil\]  
    end  
  },  
  view: \-\>(model) { RatatuiRuby::Paragraph.new(text: model.status) }  
).run

### **Scenario B: The "Structured Tool" (Rubyist Style)**

*Target: Complex CLI Utilities.*

Ruby

\# app/update\_service.rb  
class UpdateService  
  def call(msg, model)  
    \# Logic goes here...  
  end  
end

RatatuiRuby::TEA::Program.new(  
  model: InitialState.new,  
  update: UpdateService.new,  
  view: MainView.new  
).run

## ---

**7\. Roadmap & Deliverables**

1. **Engine Update:** Ship poll\_event(timeout) in ratatui\_ruby (Rust Extension).  
2. **TEA Core:** Ship ratatui\_ruby-tea containing Program, Cmd, Msg, and the Ractor Safety Validators.  
3. **Batteries:** Ship Cmd::Exec, Cmd::NetHttp, and Cmd::Batch.  
4. **Docs:** Publish "The Toolsmith's Guide to Ratatui" (focusing on TEA) distinct from "Building Dashboards" (focusing on Components/Trails).

---

Signed:  
The Council of Architects  
The RatatuiRuby Staff